// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
}

enum GradeType {
  COURSE
  HOMEWORK
  TEST
}

enum AttendanceStatus {
  PRESENT
  EXCUSED_ABSENCE
  UNEXCUSED_ABSENCE
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  coursesAsStudent    CourseEnrollment[]
  coursesAsTeacher    Course[]
  submissions         Submission[]
  grades              Grade[]
  comments            Comment[]
  chatMessages        ChatMessage[]
  testAttempts        TestAttempt[]
  testAttemptComments TestAttemptComment[]
  groupsAsTeacher     Group[]
  groupMemberships    GroupMember[]
  homeworkSubmissions HomeworkSubmission[]
  homeworkGrades      HomeworkGrade[]
  homeworkComments    HomeworkComment[]
  gradeRecords        StudentGradeRecord[]

  @@map("users")
}

enum Difficulty {
  LOW
  MEDIUM
  HIGH
}

model Course {
  id           String   @id @default(uuid())
  title        String
  description  String?
  teacherId    String
  isPrivate    Boolean  @default(false) // Персональный курс
  allowedEmails String? // Список email через запятую для персональных курсов
  difficulty   Difficulty @default(MEDIUM) // Сложность курса
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  teacher       User                @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments   CourseEnrollment[]
  materials     Material[]
  assignments   Assignment[]
  progress      Progress[]
  tests         Test[]
  chatTopics    ChatTopic[]
  groupAssignments GroupCourseAssignment[]

  @@map("courses")
}

model CourseEnrollment {
  id        String   @id @default(uuid())
  studentId String
  courseId  String
  enrolledAt DateTime @default(now())

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("course_enrollments")
}

model Material {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  type        String   // video, text, scorm, file, image
  contentUrl  String?  // URL to the material file
  order       Int      @default(0)
  assignmentId String? // Связь с заданием (после материала выполнить задание)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course     Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignment Assignment?       @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  versions   MaterialVersion[]

  @@map("materials")
}

model Assignment {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  dueDate     DateTime?
  maxScore    Int      @default(100)
  difficulty  Difficulty @default(MEDIUM) // Сложность задания
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions Submission[]
  materials  Material[]  // Материалы, связанные с заданием

  @@map("assignments")
}

model Submission {
  id          String           @id @default(uuid())
  assignmentId String
  studentId   String
  fileUrl     String
  status      AssignmentStatus @default(PENDING)
  submittedAt DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  assignment Assignment          @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grade      Grade?
  comments   Comment[]
  versions   SubmissionVersion[]

  @@map("submissions")
}

model Grade {
  id          String   @id @default(uuid())
  submissionId String  @unique
  studentId   String
  score       Int
  maxScore    Int
  feedback    String?
  gradedAt    DateTime @default(now())
  gradedBy    String?  // teacher ID

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("grades")
}

model Comment {
  id          String   @id @default(uuid())
  submissionId String
  authorId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Progress {
  id          String   @id @default(uuid())
  courseId    String
  studentId   String
  materialId  String?
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, materialId])
  @@map("progress")
}

// Версионирование материалов
model MaterialVersion {
  id          String   @id @default(uuid())
  materialId  String
  version     Int      @default(1)
  title       String
  description String?
  contentUrl  String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  createdBy   String?  // teacher ID

  // Relations
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, version])
  @@map("material_versions")
}

// Версионирование домашних заданий
model SubmissionVersion {
  id          String   @id @default(uuid())
  submissionId String
  version     Int      @default(1)
  fileUrl     String
  submittedAt DateTime @default(now())
  comment     String?  // Комментарий к версии

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, version])
  @@map("submission_versions")
}

// Тесты
model Test {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  maxScore    Int      @default(100)
  timeLimit   Int?     // Лимит времени в минутах
  isActive    Boolean  @default(true) // Можно ли еще проходить
  autoGrade   Boolean  @default(true) // Автоматическая проверка
  difficulty  Difficulty @default(MEDIUM) // Сложность теста
  closedAt    DateTime? // Дата закрытия теста
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions   Question[]
  attempts   TestAttempt[]

  @@map("tests")
}

model Question {
  id          String   @id @default(uuid())
  testId      String
  type        String   // multiple_choice, matching, true_false
  question    String
  order       Int      @default(0)
  points      Int      @default(1)
  createdAt   DateTime @default(now())

  // Relations
  test        Test        @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers     Answer[]
  attempts    TestAttemptAnswer[]

  @@map("questions")
}

model Answer {
  id          String   @id @default(uuid())
  questionId  String
  text        String
  isCorrect   Boolean  @default(false)
  order       Int      @default(0)
  matchKey    String?  // Для типа matching

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answers")
}

model TestAttempt {
  id          String   @id @default(uuid())
  testId      String
  studentId   String
  score       Int?
  maxScore    Int
  startedAt   DateTime @default(now())
  completedAt DateTime?
  answers     TestAttemptAnswer[]

  // Relations
  test    Test  @relation(fields: [testId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("test_attempts")
}

model TestAttemptAnswer {
  id          String   @id @default(uuid())
  attemptId   String
  questionId  String
  answerIds   String[] // Массив ID выбранных ответов (для multiple_choice, matching)
  textAnswer  String?  // Текстовый ответ (для text_input)
  isCorrect   Boolean?
  points      Int?

  // Relations
  attempt  TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("test_attempt_answers")
}

model TestAttemptComment {
  id          String   @id @default(uuid())
  attemptId   String
  authorId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  attempt TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("test_attempt_comments")
}

// Группы
model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teacher       User                  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  members       GroupMember[]
  homeworks     Homework[]
  courseAssignments GroupCourseAssignment[]
  chatTopics    ChatTopic[]
  gradeRecords  StudentGradeRecord[]

  @@map("groups")
}

model GroupMember {
  id        String   @id @default(uuid())
  groupId   String
  studentId String
  joinedAt  DateTime @default(now())

  // Relations
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@map("group_members")
}

// Домашние задания для групп
model Homework {
  id          String   @id @default(uuid())
  groupId     String
  title       String
  description String?
  instructions String? // Инструкции по выполнению
  requirements String? // Требования к выполнению
  resources   String? // Ресурсы и материалы
  dueDate     DateTime?
  maxScore    Int      @default(100)
  isActive    Boolean  @default(true) // Можно ли еще отправлять
  autoGrade   Boolean  @default(false) // Автоматическая проверка
  difficulty  Difficulty @default(MEDIUM) // Сложность ДЗ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  group      Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  submissions HomeworkSubmission[]

  @@map("homeworks")
}

model HomeworkSubmission {
  id          String           @id @default(uuid())
  homeworkId  String
  studentId   String
  fileUrl     String
  status      AssignmentStatus @default(PENDING)
  submittedAt DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  homework Homework          @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grade    HomeworkGrade?
  comments HomeworkComment[]

  @@map("homework_submissions")
}

model HomeworkGrade {
  id          String   @id @default(uuid())
  submissionId String  @unique
  studentId   String
  score       Int
  maxScore    Int
  feedback    String?
  gradedAt    DateTime @default(now())
  gradedBy    String?  // teacher ID

  // Relations
  submission HomeworkSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  student    User               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("homework_grades")
}

model HomeworkComment {
  id          String   @id @default(uuid())
  submissionId String
  authorId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  submission HomeworkSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User               @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("homework_comments")
}

// Назначение курсов группам
model GroupCourseAssignment {
  id        String   @id @default(uuid())
  groupId   String
  courseId  String
  assignedAt DateTime @default(now())
  assignedBy String   // teacher ID

  // Relations
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([groupId, courseId])
  @@map("group_course_assignments")
}

// Записи успеваемости студентов по дням
model StudentGradeRecord {
  id          String   @id @default(uuid())
  studentId   String
  groupId     String
  gradeDate   DateTime // Дата оценки
  gradeType   GradeType // COURSE, HOMEWORK, TEST
  relatedId   String   // ID курса/ДЗ/теста
  score       Int?
  maxScore    Int
  status      AttendanceStatus @default(PRESENT)
  feedback    String?
  gradedAt    DateTime @default(now())
  gradedBy    String?  // teacher ID
  updatedAt   DateTime @updatedAt

  // Relations
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([studentId, groupId, gradeDate])
  @@map("student_grade_records")
}

// Чат
model ChatTopic {
  id          String   @id @default(uuid())
  courseId    String?
  groupId     String?
  title       String
  description String?
  isPrivate   Boolean  @default(false) // Приватная тема
  participantId String? // ID участника личного чата (для чатов студент-преподаватель)
  createdAt   DateTime @default(now())
  createdBy   String   // user ID

  // Relations
  course  Course?     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  group   Group?      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("chat_topics")
}

model ChatMessage {
  id          String   @id @default(uuid())
  topicId     String
  authorId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  topic  ChatTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

